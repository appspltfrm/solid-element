{"version":3,"file":"defineLazyCustomElement.js","sources":["../src/lib/defineLazyCustomElement.ts"],"sourcesContent":["import {CustomElement} from \"./customElement\";\nimport {customElementBirthmark} from \"./customElementBirthmark\";\nimport {CustomElementComponent} from \"./defineComponent\";\nimport {buildFinalClass} from \"./internals/buildFinalClass\";\nimport {InternalClass} from \"./internals/InternalClass\";\n\ntype LazyType = Promise<CustomElementConstructor | {default: CustomElementConstructor} | CustomElementComponent<any, CustomElement> | {default: CustomElementComponent<any, CustomElement>}>;\n\nconst elements: {[tagName: string]: () => LazyType} = {};\nconst loading: {[tagName: string]: Promise<void>} = {};\n\nconst observer = \"MutationObserver\" in globalThis ? new MutationObserver(async (mutations) => {\n\n    // elements that were defined within this call\n    let definedElements: string[] = [];\n\n    for (const m of mutations) {\n        if (m.addedNodes) {\n            for (const n of m.addedNodes) {\n\n                if (n instanceof Element && elements[n.tagName]) {\n                    const tagName = n.tagName;\n\n                    if (!definedElements.includes(tagName) && !customElements.get(tagName)) {\n\n                        if (!(tagName in loading)) {\n                            loading[tagName] = new Promise(async (resolve) => {\n                                try {\n                                    let elementClass = await elements[n.tagName]();\n                                    if (typeof elementClass === \"object\") {\n                                        elementClass = elementClass.default;\n                                    }\n\n                                    if (typeof elementClass === \"function\" && (elementClass as unknown as CustomElementComponent<any, CustomElement>).defineCustomElement) {\n                                        (elementClass as unknown as CustomElementComponent<any, CustomElement>).defineCustomElement();\n\n                                    } else {\n\n                                        if ((elementClass as unknown as InternalClass)[customElementBirthmark]) {\n                                            elementClass = buildFinalClass(elementClass as any);\n                                        }\n\n                                        customElements.define(n.tagName.toLowerCase(), elementClass as any);\n                                    }\n\n                                    resolve();\n                                } catch (e) {\n                                    console.error(e);\n                                    delete loading[tagName];\n                                }\n                            })\n                        }\n\n                        await loading[tagName];\n\n                        definedElements.push(n.tagName);\n                    }\n\n                    if (definedElements.includes(n.tagName)) {\n                        customElements.upgrade(n);\n                    }\n                }\n            }\n        }\n    }\n\n    for (const e of definedElements) {\n        delete elements[e];\n        delete loading[e];\n    }\n\n    if (Object.keys(elements).length === 0) {\n        observer?.disconnect();\n    }\n}) : undefined;\n\nlet connected = false;\n\nexport function defineLazyCustomElement(tagName: string, loader: () => LazyType): void {\n\n    tagName = tagName.toUpperCase();\n\n    if (customElements.get(tagName) || elements[tagName]) {\n        throw new Error(`Custom element ${tagName} already defined`);\n    }\n\n    elements[tagName] = loader;\n\n    if (!connected) {\n        connected = true;\n        observer?.observe(document, {subtree: true, childList: true});\n    }\n}\n"],"names":[],"mappings":";;AAQA,MAAM,WAAgD,CAAA;AACtD,MAAM,UAA8C,CAAA;AAEpD,MAAM,WAAW,sBAAsB,aAAa,IAAI,iBAAiB,OAAO,cAAc;AAG1F,MAAI,kBAA4B,CAAA;AAEhC,aAAW,KAAK,WAAW;AACvB,QAAI,EAAE,YAAY;AACd,iBAAW,KAAK,EAAE,YAAY;AAE1B,YAAI,aAAa,WAAW,SAAS,EAAE,OAAO,GAAG;AAC7C,gBAAM,UAAU,EAAE;AAElB,cAAI,CAAC,gBAAgB,SAAS,OAAO,KAAK,CAAC,eAAe,IAAI,OAAO,GAAG;AAEpE,gBAAI,EAAE,WAAW,UAAU;AACvB,sBAAQ,OAAO,IAAI,IAAI,QAAQ,OAAO,YAAY;AAC9C,oBAAI;AACA,sBAAI,eAAe,MAAM,SAAS,EAAE,OAAO,EAAA;AAC3C,sBAAI,OAAO,iBAAiB,UAAU;AAClC,mCAAe,aAAa;AAAA,kBAChC;AAEA,sBAAI,OAAO,iBAAiB,cAAe,aAAuE,qBAAqB;AAClI,iCAAuE,oBAAA;AAAA,kBAE5E,OAAO;AAEH,wBAAK,aAA0C,sBAAsB,GAAG;AACpE,qCAAe,gBAAgB,YAAmB;AAAA,oBACtD;AAEA,mCAAe,OAAO,EAAE,QAAQ,YAAA,GAAe,YAAmB;AAAA,kBACtE;AAEA,0BAAA;AAAA,gBACJ,SAAS,GAAG;AACR,0BAAQ,MAAM,CAAC;AACf,yBAAO,QAAQ,OAAO;AAAA,gBAC1B;AAAA,cACJ,CAAC;AAAA,YACL;AAEA,kBAAM,QAAQ,OAAO;AAErB,4BAAgB,KAAK,EAAE,OAAO;AAAA,UAClC;AAEA,cAAI,gBAAgB,SAAS,EAAE,OAAO,GAAG;AACrC,2BAAe,QAAQ,CAAC;AAAA,UAC5B;AAAA,QACJ;AAAA,MACJ;AAAA,IACJ;AAAA,EACJ;AAEA,aAAW,KAAK,iBAAiB;AAC7B,WAAO,SAAS,CAAC;AACjB,WAAO,QAAQ,CAAC;AAAA,EACpB;AAEA,MAAI,OAAO,KAAK,QAAQ,EAAE,WAAW,GAAG;AACpC,cAAU,WAAA;AAAA,EACd;AACJ,CAAC,IAAI;AAEL,IAAI,YAAY;AAET,SAAS,wBAAwB,SAAiB,QAA8B;AAEnF,YAAU,QAAQ,YAAA;AAElB,MAAI,eAAe,IAAI,OAAO,KAAK,SAAS,OAAO,GAAG;AAClD,UAAM,IAAI,MAAM,kBAAkB,OAAO,kBAAkB;AAAA,EAC/D;AAEA,WAAS,OAAO,IAAI;AAEpB,MAAI,CAAC,WAAW;AACZ,gBAAY;AACZ,cAAU,QAAQ,UAAU,EAAC,SAAS,MAAM,WAAW,MAAK;AAAA,EAChE;AACJ;"}