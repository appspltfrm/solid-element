{"version":3,"file":"customElement.js","sources":["../src/lib/customElement.ts"],"sourcesContent":["import {AssignableType} from \"@appspltfrm/js-utils/core\";\nimport {CustomElementBirthmark, customElementBirthmark} from \"./customElementBirthmark\";\nimport {\n    CustomElementDisconnectedCallback,\n    CustomElementInterface,\n    CustomElementPropertyValueChangeCallback\n} from \"./CustomElementInterface\";\nimport {CustomElementOptions} from \"./CustomElementOptions\";\nimport {CallbackName} from \"./internals/CallbackName\";\nimport {callbacksProp} from \"./internals/callbacksProp\";\nimport {classesProp} from \"./internals/classesProp\";\nimport {fromAttributeValue} from \"./internals/fromAttributeValue\";\nimport {globalStylesProp} from \"./internals/globalStylesProp\";\nimport {InternalInstance} from \"./internals/InternalInstance\";\nimport {preValuesProp} from \"./internals/preValuesProp\";\nimport {ReactivePropsMap} from \"./internals/ReactivePropsMap\";\nimport {reactivePropsProp} from \"./internals/reactivePropsProp\";\nimport {renderRootProp} from \"./internals/renderRootProp\";\nimport {stylesProp} from \"./internals/stylesProp\";\n\nexport type CustomElement = HTMLElement & CustomElementInterface;\n\nexport type CustomElementClass<Type extends HTMLElement> = {new (): Type & CustomElementInterface} & CustomElementBirthmark;\n\nexport function customElement<Type extends HTMLElement = HTMLElement>(baseTypeOrOptions?: AssignableType<Type> | CustomElementOptions, options?: CustomElementOptions): CustomElementClass<Type> {\n\n    // @ts-ignore\n    const BaseType: AssignableType<Type> = typeof baseTypeOrOptions === \"function\" ? baseTypeOrOptions : (\"HTMLElement\" in globalThis ? HTMLElement : Object);\n\n    if (typeof baseTypeOrOptions === \"object\") {\n        options = baseTypeOrOptions;\n    }\n\n    if (!options) {\n        options = {};\n    }\n\n    if (!options.renderRoot) {\n        options.renderRoot = \"shadow\";\n    }\n\n    if (options.reactive) {\n        for (const propName of Object.keys(options.reactive)) {\n            if (typeof options.reactive[propName] === \"boolean\") {\n                options.reactive[propName] = {};\n            }\n        }\n    }\n\n    // @ts-ignore\n    const newClass = class CustomElementBase extends BaseType! implements CustomElementInterface {\n        static readonly [customElementBirthmark] = true;\n\n        constructor() {\n            super();\n\n            const ownPropNames = Object.getOwnPropertyNames(this).filter(p => p !== \"_$owner\");\n            const preValues: {[propName: string]: any} = {};\n            let hasPreValue = false;\n\n            for (const propName of ownPropNames) {\n                const descriptor = Object.getOwnPropertyDescriptor(this, propName);\n                if (descriptor?.writable) {\n                    preValues[propName] = descriptor.value;\n                    hasPreValue = true;\n                }\n            }\n\n            // we must also check for attributes, for initial values\n            const reactiveProps = Object.getPrototypeOf(this).constructor[reactivePropsProp] as ReactivePropsMap;\n            for (const [propName, propDefinition] of Object.entries(reactiveProps)) {\n                if (!ownPropNames.includes(propName) && this.hasAttribute(propDefinition.attribute!)) {\n                    preValues[propName] = fromAttributeValue(this.getAttribute(propDefinition.attribute!), propDefinition);\n                    hasPreValue = true;\n                }\n            }\n\n            if (hasPreValue) {\n                Object.defineProperty(this, preValuesProp, {value: preValues, enumerable: false, writable: true});\n            }\n\n            Object.defineProperty(this, callbacksProp, {value: [], enumerable: false, writable: false});\n        }\n\n        get [customElementBirthmark](): true {\n            return true;\n        }\n\n        get renderRoot(): this | ShadowRoot {\n\n            if (options!.renderRoot === \"element\") {\n                return this;\n            }\n\n            return this.shadowRoot ?? this.attachShadow({mode: options!.mode || \"open\", slotAssignment: options!.slotAssignment, delegatesFocus: options!.delegatesFocus});\n        }\n\n        addDisconnectedCallback(callback: CustomElementDisconnectedCallback) {\n            return addCallback(this, CallbackName.disconnected, callback);\n        }\n\n        addPropertyValueChangeCallback(callback: CustomElementPropertyValueChangeCallback) {\n            return addCallback(this, CallbackName.propertyValueChange, callback);\n        }\n    }\n\n    Object.defineProperty(newClass, reactivePropsProp, {value: options.reactive ?? {}});\n    Object.defineProperty(newClass, renderRootProp, {value: options.renderRoot});\n    Object.defineProperty(newClass, classesProp, {value: options.classes});\n\n    if (options.styles && options.renderRoot !== \"element\") {\n        Object.defineProperty(newClass, stylesProp, {value: Array.isArray(options.styles) ? options.styles : [options.styles]});\n    }\n\n    if (options.globalStyles || (options.renderRoot === \"element\" && options.styles)) {\n        const styles = [options.globalStyles, (options.renderRoot === \"element\" ? options.styles : undefined)].flat().filter(s => !!s);\n        Object.defineProperty(newClass, globalStylesProp, {value: styles});\n    }\n\n    Object.defineProperty(newClass.prototype, \"template\", {value: () => undefined});\n    Object.defineProperty(newClass.prototype, \"connectedCallback\", {value: () => undefined});\n    Object.defineProperty(newClass.prototype, \"disconnectedCallback\", {value: () => undefined});\n\n    return newClass as any;\n}\n\nfunction addCallback(element: HTMLElement, name: CallbackName, callback: (...args: any[]) => any) {\n    const callbacks = (element as unknown as InternalInstance)[callbacksProp];\n    if (!callbacks.find(c => c[0] === name && c[1] === callback)) {\n        callbacks.push([name, callback]);\n    }\n\n    return () => {\n        const i = callbacks.findIndex(c => c[0] === name && c[1] === callback);\n        if (i > -1) {\n            callbacks.splice(i, 1);\n        }\n    }\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;AAwBgB,SAAA,cAAsD,mBAAiE,SAA0D;;AAG7L,QAAM,WAAiC,OAAO,sBAAsB,aAAa,oBAAqB,iBAAiB,aAAa,cAAc;AAE9I,MAAA,OAAO,sBAAsB,UAAU;AAC7B,cAAA;AAAA,EAAA;AAGd,MAAI,CAAC,SAAS;AACV,cAAU,CAAC;AAAA,EAAA;AAGX,MAAA,CAAC,QAAQ,YAAY;AACrB,YAAQ,aAAa;AAAA,EAAA;AAGzB,MAAI,QAAQ,UAAU;AAClB,eAAW,YAAY,OAAO,KAAK,QAAQ,QAAQ,GAAG;AAClD,UAAI,OAAO,QAAQ,SAAS,QAAQ,MAAM,WAAW;AACzC,gBAAA,SAAS,QAAQ,IAAI,CAAC;AAAA,MAAA;AAAA,IAClC;AAAA,EACJ;AAIE,QAAA,YAAW,mBAAgC,SAA4C;AAAA,IAGzF,cAAc;AACJ,YAAA;AAEA,YAAA,eAAe,OAAO,oBAAoB,IAAI,EAAE,OAAO,CAAA,MAAK,MAAM,SAAS;AACjF,YAAM,YAAuC,CAAC;AAC9C,UAAI,cAAc;AAElB,iBAAW,YAAY,cAAc;AACjC,cAAM,aAAa,OAAO,yBAAyB,MAAM,QAAQ;AACjE,YAAI,yCAAY,UAAU;AACZ,oBAAA,QAAQ,IAAI,WAAW;AACnB,wBAAA;AAAA,QAAA;AAAA,MAClB;AAIJ,YAAM,gBAAgB,OAAO,eAAe,IAAI,EAAE,YAAY,iBAAiB;AAC/E,iBAAW,CAAC,UAAU,cAAc,KAAK,OAAO,QAAQ,aAAa,GAAG;AAChE,YAAA,CAAC,aAAa,SAAS,QAAQ,KAAK,KAAK,aAAa,eAAe,SAAU,GAAG;AACxE,oBAAA,QAAQ,IAAI,mBAAmB,KAAK,aAAa,eAAe,SAAU,GAAG,cAAc;AACvF,wBAAA;AAAA,QAAA;AAAA,MAClB;AAGJ,UAAI,aAAa;AACN,eAAA,eAAe,MAAM,eAAe,EAAC,OAAO,WAAW,YAAY,OAAO,UAAU,KAAA,CAAK;AAAA,MAAA;AAG7F,aAAA,eAAe,MAAM,eAAe,EAAC,OAAO,CAAC,GAAG,YAAY,OAAO,UAAU,MAAA,CAAM;AAAA,IAAA;AAAA,IAG9F,MAjCiB,6BAiCZ,uBAAsB,IAAU;AAC1B,aAAA;AAAA,IAAA;AAAA,IAGX,IAAI,aAAgC;AAE5B,UAAA,QAAS,eAAe,WAAW;AAC5B,eAAA;AAAA,MAAA;AAGX,aAAO,KAAK,cAAc,KAAK,aAAa,EAAC,MAAM,QAAS,QAAQ,QAAQ,gBAAgB,QAAS,gBAAgB,gBAAgB,QAAS,gBAAe;AAAA,IAAA;AAAA,IAGjK,wBAAwB,UAA6C;AACjE,aAAO,YAAY,MAAM,aAAa,cAAc,QAAQ;AAAA,IAAA;AAAA,IAGhE,+BAA+B,UAAoD;AAC/E,aAAO,YAAY,MAAM,aAAa,qBAAqB,QAAQ;AAAA,IAAA;AAAA,EAE3E,GArDI,cADa,IACI,IAA0B,OAD9B;AAwDV,SAAA,eAAe,UAAU,mBAAmB,EAAC,OAAO,QAAQ,YAAY,CAAA,GAAG;AAClF,SAAO,eAAe,UAAU,gBAAgB,EAAC,OAAO,QAAQ,YAAW;AAC3E,SAAO,eAAe,UAAU,aAAa,EAAC,OAAO,QAAQ,SAAQ;AAErE,MAAI,QAAQ,UAAU,QAAQ,eAAe,WAAW;AACpD,WAAO,eAAe,UAAU,YAAY,EAAC,OAAO,MAAM,QAAQ,QAAQ,MAAM,IAAI,QAAQ,SAAS,CAAC,QAAQ,MAAM,GAAE;AAAA,EAAA;AAG1H,MAAI,QAAQ,gBAAiB,QAAQ,eAAe,aAAa,QAAQ,QAAS;AAC9E,UAAM,SAAS,CAAC,QAAQ,cAAe,QAAQ,eAAe,YAAY,QAAQ,SAAS,MAAU,EAAE,OAAO,OAAO,CAAK,MAAA,CAAC,CAAC,CAAC;AAC7H,WAAO,eAAe,UAAU,kBAAkB,EAAC,OAAO,QAAO;AAAA,EAAA;AAG9D,SAAA,eAAe,SAAS,WAAW,YAAY,EAAC,OAAO,MAAM,QAAU;AACvE,SAAA,eAAe,SAAS,WAAW,qBAAqB,EAAC,OAAO,MAAM,QAAU;AAChF,SAAA,eAAe,SAAS,WAAW,wBAAwB,EAAC,OAAO,MAAM,QAAU;AAEnF,SAAA;AACX;AAEA,SAAS,YAAY,SAAsB,MAAoB,UAAmC;AACxF,QAAA,YAAa,QAAwC,aAAa;AACxE,MAAI,CAAC,UAAU,KAAK,CAAA,MAAK,EAAE,CAAC,MAAM,QAAQ,EAAE,CAAC,MAAM,QAAQ,GAAG;AAC1D,cAAU,KAAK,CAAC,MAAM,QAAQ,CAAC;AAAA,EAAA;AAGnC,SAAO,MAAM;AACH,UAAA,IAAI,UAAU,UAAU,CAAK,MAAA,EAAE,CAAC,MAAM,QAAQ,EAAE,CAAC,MAAM,QAAQ;AACrE,QAAI,IAAI,IAAI;AACE,gBAAA,OAAO,GAAG,CAAC;AAAA,IAAA;AAAA,EAE7B;AACJ;"}