{"version":3,"file":"customElement.js","sources":["../src/lib/customElement.ts"],"sourcesContent":["import {AssignableType} from \"@appspltfrm/js-utils/core\";\nimport {CustomElementBirthmark, customElementBirthmark} from \"./customElementBirthmark\";\nimport {\n    CustomElementDisconnectedCallback,\n    CustomElementInterface,\n    CustomElementPropertyValueChangeCallback\n} from \"./CustomElementInterface\";\nimport {CustomElementOptions} from \"./CustomElementOptions\";\nimport {CallbackName} from \"./internals/CallbackName\";\nimport {callbacksProp} from \"./internals/callbacksProp\";\nimport {classesProp} from \"./internals/classesProp\";\nimport {fromAttributeValue} from \"./internals/fromAttributeValue\";\nimport {globalStylesProp} from \"./internals/globalStylesProp\";\nimport {InternalInstance} from \"./internals/InternalInstance\";\nimport {preValuesProp} from \"./internals/preValuesProp\";\nimport {ReactivePropsMap} from \"./internals/ReactivePropsMap\";\nimport {reactivePropsProp} from \"./internals/reactivePropsProp\";\nimport {renderRootProp} from \"./internals/renderRootProp\";\nimport {stylesProp} from \"./internals/stylesProp\";\n\nexport type CustomElement = HTMLElement & CustomElementInterface;\n\nexport type CustomElementClass<Type extends HTMLElement> = {new (): Type & CustomElementInterface} & CustomElementBirthmark;\n\nexport function customElement<Type extends HTMLElement = HTMLElement>(baseTypeOrOptions?: AssignableType<Type> | CustomElementOptions, options?: CustomElementOptions): CustomElementClass<Type> {\n\n    // @ts-ignore\n    const BaseType: AssignableType<Type> = typeof baseTypeOrOptions === \"function\" ? baseTypeOrOptions : (\"HTMLElement\" in globalThis ? HTMLElement : Object);\n\n    if (typeof baseTypeOrOptions === \"object\") {\n        options = baseTypeOrOptions;\n    }\n\n    if (!options) {\n        options = {};\n    }\n\n    if (!options.renderRoot) {\n        options.renderRoot = \"shadow\";\n    }\n\n    if (options.reactive) {\n        for (const propName of Object.keys(options.reactive)) {\n            if (typeof options.reactive[propName] === \"boolean\") {\n                options.reactive[propName] = {};\n            }\n        }\n    }\n\n    // @ts-ignore\n    const newClass = class CustomElementBase extends BaseType! implements CustomElementInterface {\n        static readonly [customElementBirthmark] = true;\n\n        constructor() {\n            super();\n\n            const ownPropNames = Object.getOwnPropertyNames(this).filter(p => p !== \"_$owner\");\n            const preValues: {[propName: string]: any} = {};\n            let hasPreValue = false;\n\n            for (const propName of ownPropNames) {\n                const descriptor = Object.getOwnPropertyDescriptor(this, propName);\n                if (descriptor?.writable) {\n                    preValues[propName] = descriptor.value;\n                    hasPreValue = true;\n                }\n            }\n\n            // we must also check for attributes, for initial values\n            const reactiveProps = Object.getPrototypeOf(this).constructor[reactivePropsProp] as ReactivePropsMap;\n            for (const [propName, propDefinition] of Object.entries(reactiveProps)) {\n                if (!ownPropNames.includes(propName) && this.hasAttribute(propDefinition.attribute!)) {\n                    preValues[propName] = fromAttributeValue(this.getAttribute(propDefinition.attribute!), propDefinition);\n                    hasPreValue = true;\n                }\n            }\n\n            if (hasPreValue) {\n                Object.defineProperty(this, preValuesProp, {value: preValues, enumerable: false, writable: true});\n            }\n\n            Object.defineProperty(this, callbacksProp, {value: [], enumerable: false, writable: false});\n        }\n\n        get [customElementBirthmark](): true {\n            return true;\n        }\n\n        get renderRoot(): this | ShadowRoot {\n\n            if (options!.renderRoot === \"element\") {\n                return this;\n            }\n\n            return this.shadowRoot ?? this.attachShadow({mode: options!.mode || \"open\", slotAssignment: options!.slotAssignment, delegatesFocus: options!.delegatesFocus});\n        }\n\n        addDisconnectedCallback(callback: CustomElementDisconnectedCallback) {\n            return addCallback(this, CallbackName.disconnected, callback);\n        }\n\n        addPropertyValueChangeCallback(callback: CustomElementPropertyValueChangeCallback) {\n            return addCallback(this, CallbackName.propertyValueChange, callback);\n        }\n    }\n\n    Object.defineProperty(newClass, reactivePropsProp, {value: options.reactive ?? {}});\n    Object.defineProperty(newClass, renderRootProp, {value: options.renderRoot});\n    Object.defineProperty(newClass, classesProp, {value: options.classes});\n\n    if (options.styles && options.renderRoot !== \"element\") {\n        Object.defineProperty(newClass, stylesProp, {value: Array.isArray(options.styles) ? options.styles : [options.styles]});\n    }\n\n    if (options.globalStyles || (options.renderRoot === \"element\" && options.styles)) {\n        const styles = [options.globalStyles, (options.renderRoot === \"element\" ? options.styles : undefined)].flat().filter(s => !!s);\n        Object.defineProperty(newClass, globalStylesProp, {value: styles});\n    }\n\n    Object.defineProperty(newClass.prototype, \"template\", {value: () => undefined});\n    Object.defineProperty(newClass.prototype, \"connectedCallback\", {value: () => undefined});\n    Object.defineProperty(newClass.prototype, \"disconnectedCallback\", {value: () => undefined});\n\n    return newClass as any;\n}\n\nfunction addCallback(element: HTMLElement, name: CallbackName, callback: (...args: any[]) => any) {\n    const callbacks = (element as unknown as InternalInstance)[callbacksProp];\n    if (!callbacks.find(c => c[0] === name && c[1] === callback)) {\n        callbacks.push([name, callback]);\n    }\n\n    return () => {\n        const i = callbacks.findIndex(c => c[0] === name && c[1] === callback);\n        if (i > -1) {\n            callbacks.splice(i, 1);\n        }\n    }\n}\n"],"names":[],"mappings":"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"}