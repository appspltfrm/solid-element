{"version":3,"file":"buildFinalClass.js","sources":["../../src/lib/internals/buildFinalClass.tsx"],"sourcesContent":["import {AssignableType} from \"@appspltfrm/js-utils/core\";\nimport {createRoot, createSignal, getOwner} from \"solid-js\";\nimport {insert} from \"solid-js/web\";\nimport {CustomElement} from \"../customElement\";\nimport {CustomElementBirthmark} from \"../customElementBirthmark\";\nimport {CustomElementInterface} from \"../CustomElementInterface\";\nimport {CustomElementReactivePropConfig} from \"../CustomElementReactivePropConfig\";\nimport {CallbackName} from \"./CallbackName\";\nimport {callbacksProp} from \"./callbacksProp\";\nimport {childrenProp} from \"./childrenProp\";\nimport {classesProp} from \"./classesProp\";\nimport {fromAttributeValue} from \"./fromAttributeValue\";\nimport {globalStylesProp} from \"./globalStylesProp\";\nimport {InternalClass} from \"./InternalClass\";\nimport {InternalInstance} from \"./InternalInstance\";\nimport {ownerProp} from \"./ownerProp\";\nimport {parentOwnerProp} from \"./parentOwnerProp\";\nimport {preValuesProp} from \"./preValuesProp\";\nimport {reactivePropsProp} from \"./reactivePropsProp\";\nimport {stylesProp} from \"./stylesProp\";\nimport {toAttributeName} from \"./toAttributeName\";\nimport {toAttributeValue} from \"./toAttributeValue\";\n\nexport function buildFinalClass(ElementClass: AssignableType<CustomElement> & CustomElementBirthmark): typeof ElementClass {\n\n    const internalClass = ElementClass as unknown as InternalClass;\n\n    const finalClass = class CustomElementFinal extends ElementClass {\n\n        static get observedAttributes() {\n            const props = internalClass[reactivePropsProp];\n            return Object.values(props).map(p => p.attribute);\n        }\n\n        constructor() {\n            super();\n        }\n\n        #initialized = false;\n\n        connectedCallback() {\n\n            const internalThis = this as unknown as HTMLElement & InternalInstance & CustomElementInterface;\n\n            if (this.#initialized) {\n                return;\n            }\n\n            this.#initialized = true;\n\n            initReactiveProps(internalThis, internalClass);\n            internalThis[preValuesProp] = undefined;\n\n            if (internalClass[classesProp]) {\n                for (const c of internalClass[classesProp]) {\n                    this.classList.add(c);\n                }\n            }\n\n            super.connectedCallback!();\n\n            createRoot((dispose: Function) => {\n\n                this.addDisconnectedCallback(() => {\n                    this.renderRoot.textContent = \"\";\n                    dispose();\n                    delete internalThis[ownerProp];\n                    delete internalThis[parentOwnerProp];\n                })\n\n                let template = super.template!({children: internalThis[childrenProp]});\n                if (template && internalClass[stylesProp] && this.renderRoot !== this) {\n                    template = <><style innerHTML={internalClass[stylesProp].join(\"\\n\")}/>{template}</>\n                }\n\n                internalThis[ownerProp] = getOwner()!;\n                internalThis[ownerProp]!.name = this.tagName;\n\n                return insert(this.renderRoot, template);\n            }, lookupContext(this) || internalThis[parentOwnerProp]);\n        }\n\n        async disconnectedCallback() {\n\n            // prevent premature releasing when element is only temporarily removed from DOM\n            await Promise.resolve();\n\n            if (this.isConnected) {\n                return;\n            }\n\n            const callbacks = (this as unknown as InternalInstance)[callbacksProp];\n\n            let callback = callbacks.pop();\n            while (callback) {\n\n                if (callback[0] === CallbackName.disconnected) {\n                    callback[1](this);\n                }\n\n                callback = callbacks.pop();\n            }\n\n            super.disconnectedCallback!();\n\n            this.#initialized = false;\n        }\n\n        attributeChangedCallback(name: string, oldVal: string, newVal: string) {\n\n            if (!this.#initialized) {\n                return;\n            }\n\n            const prop = lookupAttributeProp(name, internalClass)!;\n\n            if (newVal == null && !(this as any)[prop[0]]) {\n                return;\n            }\n\n            (this as any)[prop[0]] = fromAttributeValue(newVal, prop[1]);\n        }\n    }\n\n    const reactiveProps = (ElementClass as unknown as InternalClass)[reactivePropsProp];\n    for (let [propName, propDefinition] of Object.entries(reactiveProps)) {\n        if (!propDefinition.attribute) {\n            propDefinition.attribute = toAttributeName(propName);\n        }\n    }\n\n    if (internalClass[globalStylesProp]) {\n        for (const css of internalClass[globalStylesProp]) {\n            if (css) {\n                const head = document.head ?? document.querySelector(\"head\");\n                const style = document.createElement(\"style\")\n                style.appendChild(document.createTextNode(css));\n                head.appendChild(style);\n            }\n        }\n    }\n\n    return finalClass;\n}\n\nfunction lookupContext(el: HTMLElement) {\n\n    if (el.assignedSlot && (el.assignedSlot as any as InternalInstance)[ownerProp]) {\n        return (el.assignedSlot as any as InternalInstance)[ownerProp];\n    }\n\n    let next = el.parentNode;\n    while (next && !(next as any as InternalInstance)[ownerProp] && !((next as Element).assignedSlot && ((next as Element).assignedSlot as any as InternalInstance)[ownerProp])) {\n        next = next.parentNode;\n    }\n\n    return next && (next as Element).assignedSlot ? ((next as Element).assignedSlot as any as InternalInstance)[ownerProp] : (el as any as InternalInstance)[ownerProp];\n}\n\nfunction lookupAttributeProp(attributeName: string, elementClass: InternalClass): [propName: string, propDefinition: CustomElementReactivePropConfig] | undefined {\n    const props = elementClass[reactivePropsProp];\n    return Object.entries(props).find(([propName, prop]) => propName === attributeName || (prop as CustomElementReactivePropConfig).attribute === attributeName);\n}\n\nfunction initReactiveProps(element: HTMLElement & CustomElementInterface & InternalInstance, elementClass: InternalClass) {\n\n    const reactiveProps = elementClass[reactivePropsProp];\n    const names = [childrenProp, ...Object.keys(reactiveProps ?? {})];\n    const preValues = element[preValuesProp];\n\n    function firePropChange(propName: string, newVal: any, oldVal: any) {\n\n        const callbacks = element[callbacksProp];\n        for (let i = 0; i < callbacks.length; i++) {\n            if (callbacks[i][0] === CallbackName.propertyValueChange) {\n                try {\n                    callbacks[i][1](element, propName, newVal, oldVal);\n                } catch (e) {\n                    console.warn(\"CustomElement property value change callback error\", e);\n                }\n            }\n        }\n\n    }\n\n    function reflectAttribute(prop: CustomElementReactivePropConfig, value: any) {\n\n        const attr = prop.attribute!;\n        value = toAttributeValue(value, prop);\n\n        if (value === undefined || value === null || value === false) {\n            element.removeAttribute(attr);\n        } else {\n            const prev = element.getAttribute(attr);\n            if (prev !== value) {\n                element.setAttribute(attr, value);\n            }\n        }\n    }\n\n    for (let i = 0; i < names.length; i++) {\n\n        const propName = names[i];\n        const propConfig = reactiveProps[propName];\n\n        let initialValue = undefined;\n        if (preValues && propName in preValues) {\n            initialValue = preValues[propName];\n        } else {\n            initialValue = (element as any)[propName];\n        }\n\n        if (propConfig?.reflect) {\n            reflectAttribute(propConfig, initialValue);\n        }\n\n        const [get, set] = createSignal(initialValue);\n\n        Object.defineProperty(element, propName, {\n            get,\n            set(newVal: any) {\n                set((oldVal: any) => {\n\n                    if (propName !== childrenProp) {\n\n                        if (propConfig?.reflect) {\n                            reflectAttribute(propConfig, newVal);\n                        }\n\n                        firePropChange(propName, newVal, oldVal);\n                    }\n\n                    return newVal;\n                })\n            },\n            enumerable: true,\n            configurable: true\n        })\n    }\n\n\n}\n"],"names":["buildFinalClass","ElementClass","_initialized","internalClass","finalClass","_classPrivateFieldLooseKey","CustomElementFinal","observedAttributes","props","reactivePropsProp","Object","values","map","p","attribute","constructor","defineProperty","writable","value","connectedCallback","internalThis","_classPrivateFieldLooseBase","initReactiveProps","preValuesProp","undefined","classesProp","c","classList","add","createRoot","dispose","addDisconnectedCallback","renderRoot","textContent","ownerProp","parentOwnerProp","template","children","childrenProp","stylesProp","_el$","_tmpl$","_$effect","innerHTML","join","getOwner","name","tagName","insert","lookupContext","disconnectedCallback","Promise","resolve","isConnected","callbacks","callbacksProp","callback","pop","CallbackName","disconnected","attributeChangedCallback","oldVal","newVal","prop","lookupAttributeProp","fromAttributeValue","reactiveProps","propName","propDefinition","entries","toAttributeName","globalStylesProp","css","head","document","querySelector","style","createElement","appendChild","createTextNode","el","assignedSlot","next","parentNode","attributeName","elementClass","find","element","names","keys","preValues","firePropChange","i","length","propertyValueChange","e","console","warn","reflectAttribute","attr","toAttributeValue","removeAttribute","prev","getAttribute","setAttribute","propConfig","initialValue","reflect","get","set","createSignal","enumerable","configurable"],"mappings":"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"}