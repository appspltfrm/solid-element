{"version":3,"file":"buildFinalClass.js","sources":["../../src/lib/internals/buildFinalClass.tsx"],"sourcesContent":["import {AssignableType} from \"@appspltfrm/js-utils/core\";\nimport {createRoot, createSignal, getOwner} from \"solid-js\";\nimport {insert} from \"solid-js/web\";\nimport {CustomElement} from \"../customElement\";\nimport {CustomElementBirthmark} from \"../customElementBirthmark\";\nimport {CustomElementInterface} from \"../CustomElementInterface\";\nimport {CustomElementReactivePropConfig} from \"../CustomElementReactivePropConfig\";\nimport {CallbackName} from \"./CallbackName\";\nimport {callbacksProp} from \"./callbacksProp\";\nimport {childrenProp} from \"./childrenProp\";\nimport {classesProp} from \"./classesProp\";\nimport {fromAttributeValue} from \"./fromAttributeValue\";\nimport {globalStylesProp} from \"./globalStylesProp\";\nimport {InternalClass} from \"./InternalClass\";\nimport {InternalInstance} from \"./InternalInstance\";\nimport {ownerProp} from \"./ownerProp\";\nimport {parentOwnerProp} from \"./parentOwnerProp\";\nimport {preValuesProp} from \"./preValuesProp\";\nimport {reactivePropsProp} from \"./reactivePropsProp\";\nimport {stylesProp} from \"./stylesProp\";\nimport {toAttributeName} from \"./toAttributeName\";\nimport {toAttributeValue} from \"./toAttributeValue\";\n\nexport function buildFinalClass(ElementClass: AssignableType<CustomElement> & CustomElementBirthmark): typeof ElementClass {\n\n    const internalClass = ElementClass as unknown as InternalClass;\n\n    const finalClass = class CustomElementFinal extends ElementClass {\n\n        static get observedAttributes() {\n            const props = internalClass[reactivePropsProp];\n            return Object.values(props).map(p => p.attribute);\n        }\n\n        constructor() {\n            super();\n        }\n\n        #initialized = false;\n\n        connectedCallback() {\n\n            const internalThis = this as unknown as HTMLElement & InternalInstance & CustomElementInterface;\n\n            if (this.#initialized) {\n                return;\n            }\n\n            this.#initialized = true;\n\n            initReactiveProps(internalThis, internalClass);\n            internalThis[preValuesProp] = undefined;\n\n            if (internalClass[classesProp]) {\n                for (const c of internalClass[classesProp]) {\n                    this.classList.add(c);\n                }\n            }\n\n            super.connectedCallback!();\n\n            createRoot((dispose: Function) => {\n\n                this.addDisconnectedCallback(() => {\n                    this.renderRoot.textContent = \"\";\n                    dispose();\n                    delete internalThis[ownerProp];\n                    delete internalThis[parentOwnerProp];\n                })\n\n                let template = super.template!({children: internalThis[childrenProp]});\n                if (template && internalClass[stylesProp] && this.renderRoot !== this) {\n                    template = <><style innerHTML={internalClass[stylesProp].join(\"\\n\")}/>{template}</>\n                }\n\n                internalThis[ownerProp] = getOwner()!;\n                internalThis[ownerProp]!.name = this.tagName;\n\n                return insert(this.renderRoot, template);\n            }, lookupContext(this) || internalThis[parentOwnerProp]);\n        }\n\n        async disconnectedCallback() {\n\n            // prevent premature releasing when element is only temporarily removed from DOM\n            await Promise.resolve();\n\n            if (this.isConnected) {\n                return;\n            }\n\n            const callbacks = (this as unknown as InternalInstance)[callbacksProp];\n\n            let callback = callbacks.pop();\n            while (callback) {\n\n                if (callback[0] === CallbackName.disconnected) {\n                    callback[1](this);\n                }\n\n                callback = callbacks.pop();\n            }\n\n            super.disconnectedCallback!();\n\n            this.#initialized = false;\n        }\n\n        attributeChangedCallback(name: string, oldVal: string, newVal: string) {\n\n            if (!this.#initialized) {\n                return;\n            }\n\n            const prop = lookupAttributeProp(name, internalClass)!;\n\n            if (newVal == null && !(this as any)[prop[0]]) {\n                return;\n            }\n\n            (this as any)[prop[0]] = fromAttributeValue(newVal, prop[1]);\n        }\n    }\n\n    const reactiveProps = (ElementClass as unknown as InternalClass)[reactivePropsProp];\n    for (let [propName, propDefinition] of Object.entries(reactiveProps)) {\n        if (!propDefinition.attribute) {\n            propDefinition.attribute = toAttributeName(propName);\n        }\n    }\n\n    if (internalClass[globalStylesProp]) {\n        for (const css of internalClass[globalStylesProp]) {\n            if (css) {\n                const head = document.head ?? document.querySelector(\"head\");\n                const style = document.createElement(\"style\")\n                style.appendChild(document.createTextNode(css));\n                head.appendChild(style);\n            }\n        }\n    }\n\n    return finalClass;\n}\n\nfunction lookupContext(el: HTMLElement) {\n\n    if (el.assignedSlot && (el.assignedSlot as any as InternalInstance)[ownerProp]) {\n        return (el.assignedSlot as any as InternalInstance)[ownerProp];\n    }\n\n    let next = el.parentNode;\n    while (next && !(next as any as InternalInstance)[ownerProp] && !((next as Element).assignedSlot && ((next as Element).assignedSlot as any as InternalInstance)[ownerProp])) {\n        next = next.parentNode;\n    }\n\n    return next && (next as Element).assignedSlot ? ((next as Element).assignedSlot as any as InternalInstance)[ownerProp] : (el as any as InternalInstance)[ownerProp];\n}\n\nfunction lookupAttributeProp(attributeName: string, elementClass: InternalClass): [propName: string, propDefinition: CustomElementReactivePropConfig] | undefined {\n    const props = elementClass[reactivePropsProp];\n    return Object.entries(props).find(([propName, prop]) => propName === attributeName || (prop as CustomElementReactivePropConfig).attribute === attributeName);\n}\n\nfunction initReactiveProps(element: HTMLElement & CustomElementInterface & InternalInstance, elementClass: InternalClass) {\n\n    const reactiveProps = elementClass[reactivePropsProp];\n    const names = [childrenProp, ...Object.keys(reactiveProps ?? {})];\n    const preValues = element[preValuesProp];\n\n    function firePropChange(propName: string, newVal: any, oldVal: any) {\n\n        const callbacks = element[callbacksProp];\n        for (let i = 0; i < callbacks.length; i++) {\n            if (callbacks[i][0] === CallbackName.propertyValueChange) {\n                try {\n                    callbacks[i][1](element, propName, newVal, oldVal);\n                } catch (e) {\n                    console.warn(\"CustomElement property value change callback error\", e);\n                }\n            }\n        }\n\n    }\n\n    function reflectAttribute(prop: CustomElementReactivePropConfig, value: any) {\n\n        const attr = prop.attribute!;\n        value = toAttributeValue(value, prop);\n\n        if (value === undefined || value === null || value === false) {\n            element.removeAttribute(attr);\n        } else {\n            const prev = element.getAttribute(attr);\n            if (prev !== value) {\n                element.setAttribute(attr, value);\n            }\n        }\n    }\n\n    for (let i = 0; i < names.length; i++) {\n\n        const propName = names[i];\n        const propConfig = reactiveProps[propName];\n\n        let initialValue = undefined;\n        if (preValues && propName in preValues) {\n            initialValue = preValues[propName];\n        } else {\n            initialValue = (element as any)[propName];\n        }\n\n        if (propConfig?.reflect) {\n            reflectAttribute(propConfig, initialValue);\n        }\n\n        const [get, set] = createSignal(initialValue);\n\n        Object.defineProperty(element, propName, {\n            get,\n            set(newVal: any) {\n                set((oldVal: any) => {\n\n                    if (propName !== childrenProp) {\n\n                        if (propConfig?.reflect) {\n                            reflectAttribute(propConfig, newVal);\n                        }\n\n                        firePropChange(propName, newVal, oldVal);\n                    }\n\n                    return newVal;\n                })\n            },\n            enumerable: true,\n            configurable: true\n        })\n    }\n\n\n}\n"],"names":["buildFinalClass","ElementClass","_initialized","internalClass","finalClass","_classPrivateFieldLooseKey","CustomElementFinal","observedAttributes","props","reactivePropsProp","Object","values","map","p","attribute","constructor","defineProperty","writable","value","connectedCallback","internalThis","_classPrivateFieldLooseBase","initReactiveProps","preValuesProp","undefined","classesProp","c","classList","add","createRoot","dispose","addDisconnectedCallback","renderRoot","textContent","ownerProp","parentOwnerProp","template","children","childrenProp","stylesProp","_el$","_tmpl$","innerHTML","join","getOwner","name","tagName","insert","lookupContext","disconnectedCallback","Promise","resolve","isConnected","callbacks","callbacksProp","callback","pop","CallbackName","disconnected","attributeChangedCallback","oldVal","newVal","prop","lookupAttributeProp","fromAttributeValue","reactiveProps","propName","propDefinition","entries","toAttributeName","globalStylesProp","css","head","document","querySelector","style","createElement","appendChild","createTextNode","el","assignedSlot","next","parentNode","attributeName","elementClass","find","element","names","keys","preValues","firePropChange","i","length","propertyValueChange","e","warn","reflectAttribute","attr","toAttributeValue","removeAttribute","prev","getAttribute","setAttribute","propConfig","initialValue","reflect","get","set","createSignal","enumerable","configurable"],"mappings":"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"}